(()=>{"use strict";let e=null,t=!1,o=null,n=[];function s(s){console.log(`[${s}] 队列长度:`,n.length,", isConnected:",t,", ws:",e?e.readyState:"null",", reconnectTimer:",o)}async function c(){if(e){e.onopen=e.onclose=e.onerror=e.onmessage=null;try{e.close()}catch(e){}e=null}const c=`ws://localhost:${((await chrome.storage.sync.get("settings")).settings||{}).port||8765}`;console.log("尝试连接到 WebSocket:",c);try{e=new WebSocket(c),e.onopen=()=>{console.log("已连接到 VS Code"),t=!0,r(!0),function(){for(s("处理队列");n.length>0&&t&&e&&e.readyState===WebSocket.OPEN;){const{message:t,sendResponse:o}=n.shift();try{e.send(JSON.stringify({type:"saveFile",content:t.content,filename:t.filename,timestamp:Date.now()})),o({success:!0})}catch(e){o({success:!1,error:"object"==typeof e&&e&&"message"in e?e.message:String(e)})}}}(),o&&(clearTimeout(o),o=null),s("ws.onopen")},e.onclose=()=>{if(console.log("WebSocket 连接已关闭"),t=!1,e)try{e.close()}catch{}e=null,r(!1),i(),a("连接已断开"),s("ws.onclose")},e.onerror=e=>{console.error("WebSocket 错误:",e),t=!1},e.onmessage=e=>{console.log("收到来自 VS Code 的消息:",e.data);try{const t=JSON.parse(e.data.toString());"projectInfo"===t.type&&(console.log("活跃项目已更新:",t.rootPath),chrome.storage.local.set({activeProject:{rootPath:t.rootPath,projectName:t.projectName,timestamp:Date.now()}}))}catch(e){console.error("解析消息失败:",e)}}}catch(e){console.error("WebSocket 连接失败:",e),t=!1,i()}}function a(e="未知错误"){n.length>0&&(n.forEach(t=>{try{t.sendResponse&&t.sendResponse({success:!1,error:e})}catch{}}),n=[],console.warn(`[debug] 队列全部清空，因：${e}`))}function r(e){chrome.tabs.query({},t=>{t.forEach(t=>{t.id&&chrome.tabs.sendMessage(t.id,{type:"connectionStatus",status:e?"connected":"disconnected"}).catch(()=>{})})})}function i(){o||(o=setTimeout(()=>{console.log("尝试重新连接..."),c()},3e3))}function l(o,c){if(!t||!e||e.readyState!==WebSocket.OPEN)return function(e,t){if(n=n.filter(e=>Date.now()-e.ts<15e3),console.log("WebSocket 未连接，消息加入队列","当前队列长度:",n.length),n.length>=50){const e=n.shift();e?.sendResponse&&e.sendResponse({success:!1,error:"消息队列已满，已丢弃一条旧请求"})}n.push({message:e,sendResponse:t,ts:Date.now()})}(o,c),void s("sendMessageToVSCode: queue");try{const t={timestamp:Date.now()};"clonePage"===o.type?(console.log("Background received clonePage message. Package size:",o.package?JSON.stringify(o.package).length:"undefined"),t.type="clonePage",t.package=o.package):"patch"===o.type?(t.type="patchFile",t.content=o.content,t.filename=o.filename,t.savePath=o.savePath||""):(t.type="saveFile",t.content=o.content,t.filename=o.filename,t.savePath=o.savePath||""),e.send(JSON.stringify(t)),s("sendMessageToVSCode: sent"),c({success:!0})}catch(e){c({success:!1,error:"object"==typeof e&&e&&"message"in e?e.message:String(e)})}}chrome.runtime.onMessage.addListener((e,o,n)=>"sendToVSCode"===e.action?(s("收到发送请求"),l(e,n),!0):"captureScreenshot"===e.action?(async function(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t||!t.id)return void e({success:!1,error:"未找到活动标签页"});const o=await chrome.tabs.captureVisibleTab(t.windowId,{format:"png"});l({action:"sendToVSCode",type:"screenshot",dataUrl:o,filename:`screenshot_${Date.now()}.png`},t=>{e({...t,dataUrl:o})})}catch(t){console.error("截图失败:",t),e({success:!1,error:"截图失败: "+String(t)})}}(n),!0):"getConnectionStatus"===e.action||"ping"===e.action?(n({connected:t}),!0):void 0),c(),chrome.storage.onChanged.addListener(t=>{if(t.settings){const o=t.settings.oldValue||{},n=t.settings.newValue||{};if(o.port!==n.port){if(console.log("端口配置已更改，重新连接..."),a("端口变更清理"),e)try{e.close()}catch{}setTimeout(()=>c(),500)}}}),setInterval(()=>{if(n.length>0){const e=Date.now();let t=0;n=n.filter(o=>!(e-o.ts>15e3&&(o.sendResponse&&o.sendResponse({success:!1,error:"处理超时，后台自动清理"}),t++,1))),t>0&&console.warn(`[debug] 定时自动清理超时队列 callback: 清理了${t}条`)}},1e4)})();
//# sourceMappingURL=background.js.map