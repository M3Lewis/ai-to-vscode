**中文** | [**English**](./README_EN.md)

# AI to VSCode Bridge

**AI to VSCode Bridge** 是一个 Chrome 扩展，旨在打通 AI 网页对话（如 ChatGPT, Claude, DeepWiki 等）与 VS Code 编辑器之间的壁垒。它允许你一键将网页上的代码块、对话内容发送到 VS Code，甚至直接创建文件或根据上下文自动补全代码。

## 🌟 核心功能

### 🛠️ 浮动面板功能 (Floating Panel Features)

对应右下角控制面板的操作按钮：

- **复制并保存 (Copy & Save)** `[Primary]`
  - **功能**: 一键提取当前 AI 回答的文本内容，并发送到 VS Code。
  - **特性**: 自动识别代码块语言，智能生成文件名。支持 DeepWiki、ChatGPT、Claude 等主流站点。

- **识别并创建 (Identify & Create)**
  - **功能**: 智能解析AI Studio Build回答中的多个代码块（如 `main.py`, `utils.py`），在 VS Code 中**批量创建对应文件**。
  - **场景**: 当 AI 给出一个完整的多文件项目结构时使用。

- **局部更新 (Partial Update)**
  - **功能**: 将 AI 修改后的代码片段应用到 VS Code 中已存在的源文件，**只更新变更部分**。
  - **场景**: 修复 Bug 或重构函数时，避免覆盖整个文件。

- **截图与复刻 (Capture & Clone)**
  - **截图元素 / 全屏截图**: 截取当前 DOM 元素或整个页面，保存为图片。
  - **复刻页面 (Clone Page)**: 抓取当前页面 DOM 结构与样式，在 VS Code 中重建为 HTML/CSS，用于快速原型复刻。

- **导出对话 (Export Chat)**
  - **功能**: 专为 Google AI Studio 设计，一键将当前对话历史导出为高质量的 Markdown 文档。
  - **特性**:
    - 自动保留代码块、表格、图片和格式。
    - 智能清洗：自动移除无关的引用链接（如 `[1]`）、UI 按钮文本和重定向链接。
    - 文件名自动包含时间戳和对话标题。

- **同步 Build 文件**: 将当前构建产物同步到项目目录（开发调试用）。

### ⚙️ 高级配置 (Advanced Settings)

对应扩展设置页面功能：

- **智能查找 (Smart Find)**: 自动检测当前网页的 Copy 按钮和回答容器，一键适配未知 AI 站点。
- **AI Studio 提示词管理**: 在 Google AI Studio 中快速加载本地 Markdown 提示词库，支持文件选择与快捷切换。
- **路径记忆管理**: 自动记录 VS Code 项目的文件路径上下文，方便下次快速定位保存位置。支持按项目隔离记忆。

## 🏗️ 架构概览

本扩展采用 **Chrome Extension + Local Server** 的架构模式与 VS Code 通信。

```plaintext
+-----------------------------------------------------+          +----------------------------------+
|                   CHROME BROWSER                    |          |            LOCAL SYSTEM          |
|                                                     |          |                                  |
|  +-------------------+      +--------------------+  |  HTTP    |  +-------------+    +---------+  |
|  |     AI Website    |      |  Extension Content |  |  POST    |  | Local Server|    | VS Code |  |
|  | (ChatGPT/Claude)  |----->|       Script       |--|--------->|  | (Port 8765) |--> | Editor  |  |
|  +-------------------+      |  (Floating Panel)  |  |          |  +-------------+    +---------+  |
|                             +--------------------+  |          |         |                |       |  |
|                                        ^            |          |         v                v       |  |
|                                        |            |          |  +-----------------------------+ |  |
|                                   +-----------+     |          |  |                             | |  |
|                                   | Site      |     |          |  |       Local File System     | |  |
|                                   | Handler   |     |          |  |                             | |  |
|                                   +-----------+     |          |  +-----------------------------+ |  |
+-----------------------------------------------------+          +----------------------------------+
```

**工作流:**
1. **识别 (Identify)**: `SiteHandler` 根据当前域名（如 deepwiki.com）识别页面结构，定位最新的回答内容。
2. **提取 (Extract)**: 用户点击悬浮窗按钮，Content Script 提取目标元素内的文本或代码。
3. **传输 (Transport)**: 扩展通过 HTTP 请求将数据发送到 VS Code 侧运行的本地服务器（通常由 VS Code 插件或独立的 server 脚本提供）。
4. **执行 (Execute)**: VS Code 接收数据并执行相应的编辑、保存操作。

## 🚀 安装与使用

### 前置要求
1. **Chrome 浏览器**
2. **VS Code**
3. **本地服务端**: 需要运行一个监听特定端口（默认 3000或其他配置端口）的本地服务，用于接收扩展的请求。

### 安装扩展
1. 克隆本项目：
   ```bash
   git clone <repository-url>
   ```
2. 安装依赖并构建：
   ```bash
   cd chrome-ext
   npm install
   npm run build
   ```
   - 选择 `chrome-ext/dist` 目录

## 🖌️ 界面与交互

### 浮动面板 (Floating Panel)

页面右下角的操作面板（参考 Image 1）：

```plaintext
+-------------------------------------------------------+
|  ⚡ VS Code Bridge               [●] 未连接   [▾] [✕] |
+-------------------------------------------------------+
|  文件名预览...                                        |
+-------------------------------------------------------+
|  代码操作                                             |
|  +-------------------------------------------------+  |
|  |  复制并保存 (Primary)                           |  |
|  +-------------------------------------------------+  |
|  +--------------+    +--------------+                 |
|  |  识别并创建  |    |   局部更新   |                 |
|  +--------------+    +--------------+                 |
|                                                       |
|  元素工具                                             |
|  [📷 截图元素]  [📋 复制元素]  [📄 复制(含子)]        |
|  [🖥️ 全屏截图]  [🔄 复刻页面]                         |
|                                                       |
|  AI Studio                                            |
|  [📥 同步文件]  [📝 导出对话]                         |
|                                                       |
|  提示词                                        [▾]    |
|  [ 提示词 1 ]  [ 提示词 2 ] ...                       |
+-------------------------------------------------------+
```

### 设置面板 (Settings Popup)

点击浏览器扩展图标打开配置页（参考 Image 2）：

```plaintext
+-------------------------------------------------------+
|  ⚙️ AI to VSCode Bridge                               |
+-------------------------------------------------------+
|  WebSocket端口: [ 8765                 ]              |
|                                                       |
|  [x] 在所有网站显示悬浮窗                             |
|                                                       |
|  启用的网站:                                          |
|  [ chat.openai.com             [删除] ]               |
|  [ claude.ai                   [删除] ]               |
|  [ ...                         [删除] ]               |
|                                                       |
|  网站选择器配置 (高级):                               |
|  [ 🪄 智能查找当前页面的COPY按钮        ]             |
|                                                       |
|  AI Studio 提示词管理 (System Instructions):          |
|  [ 未选择文件             ] [📁选择] [添加提示词]     |
|                                                       |
|  📂 文件保存路径:                                     |
|  [ docs/ai-responses                  ]               |
|                                                       |
|  📂 路径记忆管理:                                     |
|  当前项目: VscodeProjects                             |
|  + 手动添加/修改记忆                                  |
|  | 文件名 (如: SKILL.md)                              |
|  | 所在目录 (如: docs/project)                        |
|  | [ 添加记忆 ]                                       |
|  +----------------------------------------------------+
|  已记住的路径:                           [ 清空全部 ] |
|  [ src/utils.ts (src/core)       [✎] [×] ]            |
|                                                       |
|  [ 💾 保存设置 ]  [ ↺ 恢复默认 ]  [📥导出] [📤导入]   |
+-------------------------------------------------------+
```

### 使用流程 (Usage Workflow)

```plaintext
1. AI 生成内容           2. 点击悬浮窗操作          3. VS Code 接收并处理
+------------------+    +-------------------+    +----------------------+
| AI Chat Interface|    | Floating Panel    |    | VS Code Editor       |
|                  |    |                   |    |                      |
| > Here is the    |    | +---------------+ |    | [File Created]       |
|   code:          |    | | [ 复制并保存] | |    |                      |
|                  |    | +-------+-------+ |    |  def hello():        |
|  def hello():    |--->|         |         |--->|      print("Hi")     |
|      print("Hi") |    |         |         |    |                      |
|                  |    |         v         |    |                      |
|                  |    |   Extracts Text   |    |                      |
+------------------+    +-------------------+    +----------------------+
```

## 📖 开发指南 (OpenSpec)

本项目使用 **OpenSpec** 规范管理变更与开发流程。

### 常用工作流

- **开始新功能**:
  ```bash
  /opsx-new "add-feature-name"
  ```
- **快速生成工件 (Proposal -> Tasks)**:
  ```bash
  /opsx-ff "change-name"
  ```
- **开始实现**:
  ```bash
  /opsx-apply "change-name"
  ```
- **完成并归档**:
  ```bash
  /opsx-archive "change-name"
  ```

### 目录结构

- `chrome-ext/`: Chrome 扩展源代码 (React/TypeScript)
- `vscode-ext/`: VS Code 扩展源代码 (TypeScript)
