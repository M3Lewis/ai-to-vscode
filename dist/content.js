(()=>{"use strict";class t{static findLatestCopyButton(){const t=performance.now();console.group("ğŸ” [æ€§èƒ½ç›‘æ§] æŸ¥æ‰¾COPYæŒ‰é’®");const e=window.location.hostname;console.log("ğŸ“ å½“å‰åŸŸå:",e),console.log("â±ï¸ å¼€å§‹æ—¶é—´:",(new Date).toLocaleTimeString());let o=null;try{if(e.includes("perplexity.ai"))console.log("ğŸ¯ ä½¿ç”¨ Perplexity ä¸“ç”¨æŸ¥æ‰¾"),o=this.findPerplexityCopyButton();else{const t=this.DEFAULT_SELECTORS.find(t=>e.includes(t.hostname));t?(console.log("âœ… æ‰¾åˆ°é»˜è®¤é…ç½®:",t.name),o=this.findButtonWithConfig(t)):(console.log("âš ï¸ ä½¿ç”¨é€šç”¨ç­–ç•¥æŸ¥æ‰¾"),o=this.findButtonGeneric())}}catch(t){console.error("âŒ æŸ¥æ‰¾æŒ‰é’®æ—¶å‘ç”Ÿé”™è¯¯:",t)}const n=(performance.now()-t).toFixed(2);return console.log("â±ï¸ æŸ¥æ‰¾è€—æ—¶:",n,"ms"),console.log("ğŸ“Š ç»“æœ:",o?"âœ… æ‰¾åˆ°æŒ‰é’®":"âŒ æœªæ‰¾åˆ°æŒ‰é’®"),console.log("ğŸ’¾ å½“å‰å†…å­˜ä½¿ç”¨:",this.getMemoryUsage()),console.groupEnd(),o}static async loadConfigs(){}static findPerplexityCopyButton(){const t=performance.now();console.group("ğŸ” [Perplexity] ä¸“ç”¨æŸ¥æ‰¾");try{console.time("æŸ¥æ‰¾å›å¤å®¹å™¨");const e=document.querySelectorAll("div.py-md.md\\:pb-headerHeight.mx-auto.max-w-threadContentWidth > div");if(console.timeEnd("æŸ¥æ‰¾å›å¤å®¹å™¨"),console.log("ğŸ“¦ å›å¤å®¹å™¨æ•°é‡:",e.length),0===e.length)return console.warn("âŒ æœªæ‰¾åˆ°å›å¤å®¹å™¨"),console.groupEnd(),null;const o=e[e.length-1];console.log("ğŸ“ ä½¿ç”¨æœ€åä¸€ä¸ªå®¹å™¨ (ç´¢å¼•:",e.length-1,")"),console.time("æŸ¥æ‰¾å¤åˆ¶æŒ‰é’®");const n=o.querySelectorAll('button[aria-label*="Copy"], button[data-testid*="copy"]');if(console.timeEnd("æŸ¥æ‰¾å¤åˆ¶æŒ‰é’®"),console.log("ğŸ”˜ å¤åˆ¶æŒ‰é’®æ•°é‡:",n.length),n.length>0){const e=n[n.length-1];return console.log("âœ… é€‰ä¸­æŒ‰é’®:",{ariaLabel:e.getAttribute("aria-label"),dataTestId:e.getAttribute("data-testid"),text:e.textContent?.trim().substring(0,20)}),console.log("â±ï¸ PerplexityæŸ¥æ‰¾è€—æ—¶:",(performance.now()-t).toFixed(2),"ms"),console.groupEnd(),e}console.warn("âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å¤åˆ¶æŒ‰é’®ï¼Œå°è¯•é€’å½’æœç´¢"),console.time("é€’å½’æœç´¢æŒ‰é’®");const s=Array.from(o.querySelectorAll("button"));console.log("ğŸ” å®¹å™¨å†…æŒ‰é’®æ€»æ•°:",s.length);for(let t=0;t<s.length;t++){const e=s[t],o=e.getAttribute("aria-label")?.toLowerCase()||"",n=e.getAttribute("data-testid")?.toLowerCase()||"",l=e.textContent?.toLowerCase()||"";if(o.includes("copy")||n.includes("copy")||l.includes("copy"))return console.log("âœ… é€’å½’æ‰¾åˆ°æŒ‰é’® (ç´¢å¼•:",t,")"),console.timeEnd("é€’å½’æœç´¢æŒ‰é’®"),console.groupEnd(),e}console.timeEnd("é€’å½’æœç´¢æŒ‰é’®")}catch(t){console.error("âŒ PerplexityæŸ¥æ‰¾å‡ºé”™:",t)}return console.warn("âŒ PerplexityæŸ¥æ‰¾å¤±è´¥"),console.groupEnd(),null}static findButtonWithConfig(t){const e=performance.now();console.group("ğŸ” [é…ç½®æŸ¥æ‰¾]",t.name);const o=t.copyButtonSelector;console.log("ğŸ¯ é€‰æ‹©å™¨:",o);try{if(window.location.hostname.includes("aistudio.google.com")){const t=this.findAIStudioCopyButton();return console.log("â±ï¸ AI StudioæŸ¥æ‰¾è€—æ—¶:",(performance.now()-e).toFixed(2),"ms"),console.groupEnd(),t}if(window.location.hostname.includes("claude.ai")){const t=this.findClaudeCopyButton();return console.log("â±ï¸ ClaudeæŸ¥æ‰¾è€—æ—¶:",(performance.now()-e).toFixed(2),"ms"),console.groupEnd(),t}if(t.responseContainerSelector){console.log("ğŸ“¦ ä½¿ç”¨å®¹å™¨é€‰æ‹©å™¨:",t.responseContainerSelector),console.time("æŸ¥æ‰¾å®¹å™¨");const e=document.querySelectorAll(t.responseContainerSelector);if(console.timeEnd("æŸ¥æ‰¾å®¹å™¨"),console.log("ğŸ“¦ å®¹å™¨æ•°é‡:",e.length),e.length>0){const t=e[e.length-1];console.time("å®¹å™¨å†…æŸ¥æ‰¾æŒ‰é’®");const n=t.querySelector(o);if(console.timeEnd("å®¹å™¨å†…æŸ¥æ‰¾æŒ‰é’®"),n)return console.log("âœ… åœ¨å®¹å™¨ä¸­æ‰¾åˆ°æŒ‰é’®"),console.groupEnd(),n}}console.warn("âš ï¸ å›é€€åˆ°å…¨å±€æŸ¥æ‰¾"),console.time("å…¨å±€æŸ¥æ‰¾æŒ‰é’®");const n=document.querySelectorAll(o);if(console.timeEnd("å…¨å±€æŸ¥æ‰¾æŒ‰é’®"),console.log("ğŸ”˜ å…¨å±€æ‰¾åˆ°æŒ‰é’®æ•°:",n.length),n.length>0)return console.log("âœ… è¿”å›æœ€åä¸€ä¸ªæŒ‰é’®"),console.groupEnd(),n[n.length-1]}catch(t){console.error("âŒ é…ç½®æŸ¥æ‰¾å‡ºé”™:",t)}return console.warn("âŒ æœªæ‰¾åˆ°æŒ‰é’®"),console.log("â±ï¸ æ€»è€—æ—¶:",(performance.now()-e).toFixed(2),"ms"),console.groupEnd(),null}static findClaudeCopyButton(){console.group("ğŸ” [Claude] ä¸“ç”¨æŸ¥æ‰¾");try{console.time("æŸ¥æ‰¾ClaudeæŒ‰é’®");const t=Array.from(document.querySelectorAll('button[data-testid="action-bar-copy"]'));if(console.timeEnd("æŸ¥æ‰¾ClaudeæŒ‰é’®"),console.log("ğŸ”˜ æ‰¾åˆ°æŒ‰é’®æ•°:",t.length),t.length>0)return console.groupEnd(),t[t.length-1];console.warn("âš ï¸ ä½¿ç”¨SVGå¤‡ç”¨æŸ¥æ‰¾"),console.time("SVGè·¯å¾„æŸ¥æ‰¾");const e=Array.from(document.querySelectorAll("button"));console.log("ğŸ” é¡µé¢æŒ‰é’®æ€»æ•°:",e.length),e.length>1e3&&console.error("âŒ æŒ‰é’®æ•°é‡å¼‚å¸¸ (>1000)ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼");for(let t=e.length-1;t>=0;t--){const o=e[t],n=o.querySelector("svg");if(n){const e=n.querySelector("path");if(e){const n=e.getAttribute("d")||"";if(n.includes("M10 1.5C11.1097")||n.includes("clipboard"))return console.log("âœ… é€šè¿‡SVGæ‰¾åˆ° (ç´¢å¼•:",t,")"),console.timeEnd("SVGè·¯å¾„æŸ¥æ‰¾"),console.groupEnd(),o}}}console.timeEnd("SVGè·¯å¾„æŸ¥æ‰¾")}catch(t){console.error("âŒ ClaudeæŸ¥æ‰¾å‡ºé”™:",t)}return console.groupEnd(),null}static findAIStudioCopyButton(){console.group("ğŸ” [AI Studio] ä¸“ç”¨æŸ¥æ‰¾");try{const t=[{name:"jslogå±æ€§",fn:()=>document.querySelector('button[mat-menu-item][jslog^="282205"]')},{name:"copy-markdown-buttonç±»",fn:()=>{const t=document.querySelector(".copy-markdown-button");return t?.closest("button[mat-menu-item]")}},{name:"Copy as markdownæ–‡æœ¬",fn:()=>Array.from(document.querySelectorAll("button[mat-menu-item]")).find(t=>t.textContent?.toLowerCase().includes("copy as markdown"))||null}];for(const e of t){console.time(e.name);const t=e.fn();if(console.timeEnd(e.name),t)return console.log("âœ… ç­–ç•¥æˆåŠŸ:",e.name),console.groupEnd(),t}}catch(t){console.error("âŒ AI StudioæŸ¥æ‰¾å‡ºé”™:",t)}return console.groupEnd(),null}static findButtonGeneric(){console.group("ğŸ” [é€šç”¨ç­–ç•¥] æŸ¥æ‰¾");const t=['button[data-testid*="copy"]','button[aria-label*="Copy" i]','button[aria-label*="å¤åˆ¶" i]','button[title*="Copy" i]',"button.copy-button","button.copy-btn",'[data-testid*="copy"]'];for(const e of t)try{console.time(`é€‰æ‹©å™¨: ${e}`);const t=document.querySelectorAll(e);if(console.timeEnd(`é€‰æ‹©å™¨: ${e}`),console.log(`  ğŸ“Š æ‰¾åˆ° ${t.length} ä¸ªæŒ‰é’®`),t.length>100&&console.warn(`  âš ï¸ æŒ‰é’®æ•°é‡è¿‡å¤š (${t.length})ï¼Œå¯èƒ½å½±å“æ€§èƒ½ï¼`),t.length>0)return console.log("  âœ… è¿”å›æœ€åä¸€ä¸ªæŒ‰é’®"),console.groupEnd(),t[t.length-1]}catch(t){console.error("  âŒ é€‰æ‹©å™¨é”™è¯¯:",t);continue}return console.error("âŒ æ‰€æœ‰é€šç”¨ç­–ç•¥éƒ½å¤±è´¥äº†"),console.groupEnd(),null}static async getClipboardContent(){const t=performance.now();console.group("ğŸ“‹ [å‰ªè´´æ¿] è¯»å–å†…å®¹");try{const e=await navigator.clipboard.readText(),o=(performance.now()-t).toFixed(2);return console.log("âœ… è¯»å–æˆåŠŸ"),console.log("ğŸ“ å†…å®¹é•¿åº¦:",e.length,"å­—ç¬¦"),console.log("â±ï¸ è¯»å–è€—æ—¶:",o,"ms"),e.length>5e4&&console.warn("âš ï¸ å†…å®¹è¿‡å¤§ (>50KB)ï¼Œå¯èƒ½å½±å“æ€§èƒ½ï¼"),console.groupEnd(),e}catch(t){throw console.error("âŒ è¯»å–å¤±è´¥:",t),console.groupEnd(),new Error("æ— æ³•è¯»å–å‰ªè´´æ¿")}}static getMemoryUsage(){if("memory"in performance){const t=performance.memory;return`${(t.usedJSHeapSize/1048576).toFixed(2)} MB / ${(t.totalJSHeapSize/1048576).toFixed(2)} MB`}return"ä¸å¯ç”¨"}static makeDraggable(t){let e,o,n,s,l=!1;const r=t.querySelector(".panel-header");r&&(r.style.cursor="move",r.addEventListener("mousedown",e=>{e.target.classList.contains("close-btn")||(l=!0,n=e.clientX-t.offsetLeft,s=e.clientY-t.offsetTop)}),document.addEventListener("mousemove",r=>{l&&(r.preventDefault(),e=r.clientX-n,o=r.clientY-s,t.style.left=`${e}px`,t.style.top=`${o}px`,t.style.right="auto",t.style.bottom="auto")}),document.addEventListener("mouseup",()=>{l=!1}))}}t.DEFAULT_SELECTORS=[{hostname:"chat.openai.com",copyButtonSelector:'button[aria-label*="Copy"]',responseContainerSelector:'[data-message-author-role="assistant"]',name:"ChatGPT"},{hostname:"claude.ai",copyButtonSelector:'button[data-testid="action-bar-copy"]',responseContainerSelector:void 0,name:"Claude"},{hostname:"gemini.google.com",copyButtonSelector:'button[aria-label="Copy"]',responseContainerSelector:".model-response",name:"Gemini"},{hostname:"perplexity.ai",copyButtonSelector:'button[aria-label="Copy"]',responseContainerSelector:void 0,name:"Perplexity"},{hostname:"aistudio.google.com",copyButtonSelector:'button[mat-menu-item][jslog^="282205"]',responseContainerSelector:void 0,name:"AI Studio"}],new class{constructor(){this.panel=null,this.statusElement=null,this.enabled=!1,this.dailyCounter=1,this.promptButtons=null,this.isDebugMode=!1,this.pathMemory={},this.initialize(),this.checkDebugMode(),this.setupStorageListener()}checkDebugMode(){this.isDebugMode=window.location.search.includes("debug=true")||"true"===localStorage.getItem("ai-vscode-debug")||"localhost"===window.location.hostname}debugLog(t,...e){this.isDebugMode&&console.log(t,...e)}debugWarn(t,...e){this.isDebugMode&&console.warn(t,...e)}async initialize(){await this.checkAndInitialize(),await this.loadDailyCounter(),await this.loadPathMemory(),this.queryConnectionStatus()}queryConnectionStatus(){chrome.runtime.sendMessage({action:"getConnectionStatus"},t=>{chrome.runtime.lastError?console.error("æŸ¥è¯¢è¿æ¥çŠ¶æ€å¤±è´¥:",chrome.runtime.lastError):t&&void 0!==t.connected&&(console.log("å½“å‰è¿æ¥çŠ¶æ€:",t.connected?"å·²è¿æ¥":"æœªè¿æ¥"),this.updateConnectionStatus(t.connected))})}async loadDailyCounter(){const t=(new Date).toDateString(),e=await chrome.storage.local.get(["lastSaveDate","dailyCounter"]);e.lastSaveDate===t?this.dailyCounter=(e.dailyCounter||0)+1:this.dailyCounter=1}async updateDailyCounter(){const t=(new Date).toDateString();await chrome.storage.local.set({lastSaveDate:t,dailyCounter:this.dailyCounter}),this.dailyCounter++}async loadPathMemory(){const t=await chrome.storage.local.get(["activeProject"]),e=t.activeProject?.rootPath||"default",o=`pathMemory_${e}`,n=await chrome.storage.local.get([o]);this.pathMemory=n[o]||{},console.log(`ğŸ“‚ [${e}] è·¯å¾„è®°å¿†å·²åŠ è½½:`,Object.keys(this.pathMemory).length,"ä¸ªæ–‡ä»¶")}async savePathMemory(){const t=await chrome.storage.local.get(["activeProject"]),e=`pathMemory_${t.activeProject?.rootPath||"default"}`;await chrome.storage.local.set({[e]:this.pathMemory})}setupStorageListener(){chrome.storage.onChanged.addListener((t,e)=>{"local"===e&&t.activeProject&&(console.log("ğŸ”„ æ£€æµ‹åˆ°æ´»è·ƒé¡¹ç›®å˜æ›´ï¼Œé‡æ–°åŠ è½½è·¯å¾„è®°å¿†"),this.loadPathMemory())})}async checkAndInitialize(){const t=(await chrome.storage.sync.get("settings")).settings||{},e=t.enabledUrls||["chat.openai.com","claude.ai","gemini.google.com","chatgpt.com","poe.com","perplexity.ai","deepseek.com","aistudio.google.com"],o=t.showOnAllSites||!1,n=window.location.hostname;o||this.isUrlEnabled(n,e)?(this.enabled=!0,this.createPanel(),this.setupMessageListener(),console.log("âœ… æ‚¬æµ®çª—å·²å¯ç”¨")):console.log("å½“å‰ç½‘ç«™æœªå¯ç”¨æ‚¬æµ®çª—:",n),chrome.storage.onChanged.addListener(t=>{t.settings&&window.location.reload()})}isUrlEnabled(t,e){return e.some(e=>{if(e.includes("*")){const o=e.replace(/\*/g,".*");return new RegExp(o).test(t)}return t.includes(e)})}createPanel(){this.panel=document.createElement("div"),this.panel.id="ai-vscode-panel",this.panel.innerHTML='\n    <div class="panel-container">\n      <div class="ai-vscode-header">\n        <span class="ai-vscode-title">å‘é€åˆ°VS Code</span>\n        <button id="toggle-prompts" class="ai-vscode-toggle" title="æŠ˜å /å±•å¼€æç¤ºè¯">â–¾</button>\n        <button id="close-panel" class="ai-vscode-close">âœ•</button>\n      </div>\n      <div id="filename-preview" class="filename-preview">æ–‡ä»¶åé¢„è§ˆ...</div>\n\n      <div id="prompt-section">\n        <div class="prompt-section-header">\n          <span>å¸¸ç”¨æç¤ºè¯</span>\n        </div>\n        <div id="prompt-buttons" class="prompt-buttons"></div>\n      </div>\n\n      <div class="ai-vscode-footer">\n        <div class="button-group">\n          <button id="send-to-vscode" class="primary">å¤åˆ¶å¹¶ä¿å­˜</button>\n          <button id="create-files-from-content" class="secondary" title="è¯†åˆ«ä»£ç å—ä¸­çš„è·¯å¾„å¹¶ç›´æ¥åˆ›å»ºæ–‡ä»¶">è¯†åˆ«å¹¶åˆ›å»º</button>\n          <button id="patch-files-from-content" class="secondary" title="æ™ºèƒ½è¯†åˆ«è·¯å¾„å¹¶å±€éƒ¨æ›´æ–°æ–‡ä»¶å†…å®¹">å±€éƒ¨æ›´æ–°</button>\n        </div>\n        <div id="connection-status" class="connection-status">\n          <span class="status-dot"></span>\n          <span class="status-text">æœªè¿æ¥</span>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(this.panel),t.makeDraggable(this.panel);const e=document.getElementById("send-to-vscode");e?.addEventListener("click",()=>this.handleSendClick());const o=document.getElementById("create-files-from-content");o?.addEventListener("click",()=>this.handleCreateFilesClick());const n=document.getElementById("patch-files-from-content");n?.addEventListener("click",()=>this.handlePartialUpdateClick());const s=document.getElementById("close-panel");s?.addEventListener("click",()=>this.togglePanel());const l=document.getElementById("toggle-prompts"),r=document.getElementById("prompt-section");l&&r&&(l.addEventListener("click",()=>{const t=r.classList.toggle("collapsed");l.textContent=t?"â–¸":"â–¾",chrome.storage.local.set({promptsCollapsed:t})}),chrome.storage.local.get("promptsCollapsed",t=>{t.promptsCollapsed&&(r.classList.add("collapsed"),l.textContent="â–¸")})),this.statusElement=document.getElementById("connection-status"),this.promptButtons=document.getElementById("prompt-buttons"),this.loadPromptButtons()}togglePanel(){this.panel&&(this.panel.style.display="none"===this.panel.style.display?"block":"none")}async handleSendClick(){const e=performance.now();console.group("ğŸš€ [å¤åˆ¶å¹¶ä¿å­˜] å®Œæ•´æµç¨‹"),console.log("â±ï¸ å¼€å§‹æ—¶é—´:",(new Date).toLocaleTimeString()),console.log("ğŸ’¾ åˆå§‹å†…å­˜:",this.getMemoryUsage());try{if(window.location.hostname.includes("aistudio.google.com"))return await this.handleAIStudioCopy(),void console.groupEnd();console.log("\nğŸ“ æ­¥éª¤1: æŸ¥æ‰¾å¤åˆ¶æŒ‰é’®");const o=t.findLatestCopyButton();if(!o)return console.error("âŒ æœªæ‰¾åˆ°COPYæŒ‰é’®"),this.showError("æœªæ‰¾åˆ°COPYæŒ‰é’®"),void console.groupEnd();console.log("\nğŸ“ æ­¥éª¤2: ç‚¹å‡»å¤åˆ¶æŒ‰é’®"),console.time("ç‚¹å‡»å¤åˆ¶"),o.click(),console.timeEnd("ç‚¹å‡»å¤åˆ¶"),console.log("\nğŸ“ æ­¥éª¤3: ç­‰å¾…å¤åˆ¶å®Œæˆ (300ms)"),await this.delay(300),console.log("\nğŸ“ æ­¥éª¤4: è¯»å–å‰ªè´´æ¿");const n=await t.getClipboardContent();if(!n||0===n.trim().length)return console.error("âŒ å‰ªè´´æ¿å†…å®¹ä¸ºç©º"),this.showError("å‰ªè´´æ¿å†…å®¹ä¸ºç©º"),void console.groupEnd();console.log("\nğŸ“ æ­¥éª¤5: ç”Ÿæˆæ–‡ä»¶å"),console.time("ç”Ÿæˆæ–‡ä»¶å");const s=this.generateSmartFilename(n);console.timeEnd("ç”Ÿæˆæ–‡ä»¶å"),console.log("ğŸ“ æ–‡ä»¶å:",s),console.log("\nğŸ“ æ­¥éª¤6: å‘é€åˆ°VS Code"),this.showFilenamePreview(s),this.sendToVSCode(n,s),console.log("\nğŸ“ æ­¥éª¤7: æ›´æ–°è®¡æ•°å™¨"),await this.updateDailyCounter();const l=performance.now();console.log("\nâœ… æµç¨‹å®Œæˆ"),console.log("â±ï¸ æ€»è€—æ—¶:",(l-e).toFixed(2),"ms"),console.log("ğŸ’¾ ç»“æŸå†…å­˜:",this.getMemoryUsage()),console.groupEnd()}catch(t){const e=t instanceof Error?t.message:"æœªçŸ¥é”™è¯¯";console.error("âŒ æµç¨‹å¤±è´¥:",t),console.log("ğŸ’¾ é”™è¯¯æ—¶å†…å­˜:",this.getMemoryUsage()),this.showError(`æ“ä½œå¤±è´¥ï¼š${e}`),console.groupEnd()}}async handleCreateFilesClick(){console.group("ğŸš€ [è¯†åˆ«å¹¶åˆ›å»ºæ–‡ä»¶] æµç¨‹å¼€å§‹");try{let e="";if(window.location.hostname.includes("aistudio.google.com")){const o=Array.from(document.querySelectorAll('button[aria-label*="options"], button[iconname="more_vert"], ms-chat-turn-options button'));if(o.length>0){o[o.length-1].click(),await this.delay(500);const n=t.findLatestCopyButton();n&&(n.click(),await this.delay(300),e=await t.getClipboardContent())}}else{const o=t.findLatestCopyButton();o&&(o.click(),await this.delay(300),e=await t.getClipboardContent())}if(!e||0===e.trim().length)return this.showError("æœªè·å–åˆ°å†…å®¹ï¼Œè¯·ç¡®ä¿é¡µé¢ä¸Šæœ‰å¯å¤åˆ¶çš„å›ç­”"),void console.groupEnd();const o=this.parseFilesFromContent(e);if(0===o.length)return this.showError("æœªåœ¨ä»£ç å—ä¸­è¯†åˆ«åˆ°æœ‰æ•ˆçš„æ–‡ä»¶è·¯å¾„"),void console.groupEnd();console.log(`ğŸ” è¯†åˆ«åˆ° ${o.length} ä¸ªæ–‡ä»¶:`,o.map(t=>t.path));let n=0;for(const t of o)try{await this.sendToVSCode(t.content,t.filename,t.savePath),n++}catch(e){console.error(`ä¿å­˜æ–‡ä»¶ ${t.path} å¤±è´¥:`,e)}n>0?(this.showSuccess(`âœ… æˆåŠŸè¯†åˆ«å¹¶åˆ›å»º ${n} ä¸ªæ–‡ä»¶`),await this.updateDailyCounter()):this.showError("åˆ›å»ºæ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥")}catch(t){console.error("è¯†åˆ«å¹¶åˆ›å»ºæ–‡ä»¶å¤±è´¥:",t),this.showError("è¯†åˆ«å¹¶åˆ›å»ºæ–‡ä»¶å¤±è´¥")}finally{console.groupEnd()}}async handlePartialUpdateClick(){console.group("ğŸš€ [å±€éƒ¨æ›´æ–°æ–‡ä»¶] æµç¨‹å¼€å§‹");try{let e="";if(window.location.hostname.includes("aistudio.google.com")){const o=Array.from(document.querySelectorAll('button[aria-label*="options"], button[iconname="more_vert"], ms-chat-turn-options button'));if(o.length>0){o[o.length-1].click(),await this.delay(500);const n=t.findLatestCopyButton();n&&(n.click(),await this.delay(300),e=await t.getClipboardContent())}}else{const o=t.findLatestCopyButton();o&&(o.click(),await this.delay(300),e=await t.getClipboardContent())}if(!e||0===e.trim().length)return this.showError("æœªè·å–åˆ°å†…å®¹"),void console.groupEnd();const o=this.parseFilesFromContent(e);if(0===o.length)return this.showError("æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„æ–‡ä»¶è·¯å¾„"),void console.groupEnd();console.log(`ğŸ” è¯†åˆ«åˆ° ${o.length} ä¸ªæ›´æ–°é¡¹:`,o.map(t=>t.path));let n=0;for(const t of o)try{await this.sendToVSCode(t.content,t.filename,t.savePath,"patch"),n++}catch(e){console.error(`æ›´æ–°æ–‡ä»¶ ${t.path} å¤±è´¥:`,e)}n>0?(this.showSuccess(`âœ… æˆåŠŸå‘é€ ${n} ä¸ªå±€éƒ¨æ›´æ–°è¯·æ±‚`),await this.updateDailyCounter()):this.showError("æ›´æ–°è¯·æ±‚å‘é€å¤±è´¥")}catch(t){console.error("å±€éƒ¨æ›´æ–°å¤±è´¥:",t),this.showError("å±€éƒ¨æ›´æ–°å¤±è´¥")}finally{console.groupEnd()}}parseFilesFromContent(t){const e=[];let o=!1;console.log("ğŸ” å¼€å§‹åˆ‡ç‰‡è§£æ (Slice First), é•¿åº¦:",t.length);const n=[];let s=0,l=!1;const r=t.split("\n");let a=0;for(let e=0;e<r.length;e++){const o=r[e];if(o.trim().startsWith("```")&&(l=!l),!l&&/^[-]{3,}$/.test(o.trim())){const e=a;e>s&&n.push(t.substring(s,e).trim()),s=a+o.length+1}a+=o.length+1}s<t.length&&n.push(t.substring(s).trim()),console.log(`ğŸ”ª åˆ‡ç‰‡æ•°é‡: ${n.length}`);for(let t=0;t<n.length;t++){const s=n[t],l=[/(?:æ–‡ä»¶å|File\s*(?:Name|Path)?|è·¯å¾„|åç§°)[:ï¼š]\s*[`"]?([a-zA-Z0-9._\-\/]+\.[a-zA-Z0-9]+)[`"]?/i,/(?:\*\*|__|\`)([a-zA-Z0-9._\-\/]+\.[a-zA-Z0-9]+)(?:\*\*|__|\`)/,/^([a-zA-Z0-9._\-\/]+\.[a-zA-Z0-9]{1,10})$/m];let r=null;for(const e of l){const o=s.match(e);if(o&&o[1]){r=o[1],console.log(`ğŸ¯ åˆ‡ç‰‡ ${t}: æ£€æµ‹åˆ°è·¯å¾„ "${r}"`);break}}if(!r){console.log(`â­ï¸ åˆ‡ç‰‡ ${t}: æœªæ£€æµ‹åˆ°è·¯å¾„ï¼Œè·³è¿‡ (å‰50å­—ç¬¦: "${s.substring(0,50).replace(/\n/g,"\\n")}...")`);continue}const a=s.match(/```(\w+)?[\r\n]+/);if(!a){console.log(`âš ï¸ åˆ‡ç‰‡ ${t}: è·¯å¾„ "${r}" åæœªæ‰¾åˆ°ä»£ç å—å¼€å§‹`);continue}const i=a[1]||"text",c=a.index+a[0].length,d=s.lastIndexOf("```");if(d<=c){console.log(`âš ï¸ åˆ‡ç‰‡ ${t}: è·¯å¾„ "${r}" çš„ä»£ç å—æœªæ­£ç¡®é—­åˆ`);continue}const u=s.substring(c,d).trim();console.log(`ğŸ“¦ åˆ‡ç‰‡ ${t}: ä»£ç å—é•¿åº¦ ${u.length} chars`);let g=r.replace(/^\.?\//,"");const m=g.split("/"),h=m.pop()||"";let p=m.join("/");if(console.log(`ğŸ“‚ è·¯å¾„è§£æ: fullPath="${g}", filename="${h}", savePath="${p}"`),!p){const t=h.toLowerCase(),e=Object.keys(this.pathMemory).find(e=>e.toLowerCase()===t);e&&(p=this.pathMemory[e],g=p?`${p}/${h}`:h,console.log(`ğŸ§  è®°å¿†åŒ¹é…: ${h} -> ${p}`))}p&&this.pathMemory[h]!==p&&(this.pathMemory[h]=p,o=!0,console.log(`ğŸ“ æ›´æ–°è·¯å¾„è®°å¿†: ${h} -> ${p}`)),e.push({path:g,filename:h,savePath:p,content:u}),console.log(`âœ… æˆåŠŸæå–: ${g} (è¯­è¨€: ${i}, ${u.length} chars)`)}return o&&this.savePathMemory(),console.log(`ğŸ“¦ æ€»å…±æå– ${e.length} ä¸ªæ–‡ä»¶`),e}async sendToVSCode(t,e,o,n="save"){try{const s=((await chrome.storage.sync.get({savePath:""})).savePath||"").trim();let l=o||"";s&&(l=l?`${s}/${l}`:s);const r={action:"sendToVSCode",content:t,filename:e,savePath:l,type:n};return new Promise((t,e)=>{chrome.runtime.sendMessage(r,o=>{chrome.runtime.lastError?e(new Error(chrome.runtime.lastError.message)):o&&o.success?t():e(new Error(o?.error||"æœªçŸ¥é”™è¯¯"))})})}catch(t){throw t}}getMemoryUsage(){if("memory"in performance){const t=performance.memory;return`${(t.usedJSHeapSize/1048576).toFixed(2)} MB / ${(t.totalJSHeapSize/1048576).toFixed(2)} MB`}return"ä¸å¯ç”¨"}async handleAIStudioCopy(){try{this.debugLog("ğŸ” AI Studio ç‰¹æ®Šå¤„ç†ï¼šæŸ¥æ‰¾èœå•æŒ‰é’®");const e=Array.from(document.querySelectorAll('button[aria-label*="options"], button[iconname="more_vert"], button[aria-label*="Open options"], ms-chat-turn-options button'));if(0===e.length)return void this.showError("æœªæ‰¾åˆ°èœå•æŒ‰é’®");const o=e[e.length-1];this.debugLog("âœ… æ‰¾åˆ°èœå•æŒ‰é’®ï¼Œå‡†å¤‡ç‚¹å‡»"),o.click(),this.debugLog("âœ… èœå•å·²å±•å¼€ï¼Œç­‰å¾…åŠ è½½..."),await this.delay(500);const n=t.findLatestCopyButton();if(!n)return console.error("âŒ èœå•å±•å¼€åä»æœªæ‰¾åˆ°å¤åˆ¶æŒ‰é’®"),this.showError("æœªæ‰¾åˆ°å¤åˆ¶æŒ‰é’®"),void o.click();this.debugLog("âœ… æ‰¾åˆ°å¤åˆ¶æŒ‰é’®ï¼Œå‡†å¤‡ç‚¹å‡»"),n.click(),await this.delay(300);const s=await t.getClipboardContent();if(!s||0===s.trim().length)return void this.showError("å‰ªè´´æ¿å†…å®¹ä¸ºç©º");if(this.debugLog("âœ… è¯»å–åˆ°å†…å®¹ï¼Œé•¿åº¦:",s.length),s.length>5e4)return void this.showError("å¯¹è¯å†…å®¹è¿‡é•¿ï¼Œæ— æ³•ç›´æ¥å¤åˆ¶ï¼Œè¯·åˆ†æ‰¹æ“ä½œï¼");const l=this.generateSmartFilename(s);this.debugLog("ğŸ“ ç”Ÿæˆæ–‡ä»¶å:",l),this.showFilenamePreview(l),this.sendToVSCode(s,l),await this.updateDailyCounter()}catch(t){const e=t instanceof Error?t.message:"æœªçŸ¥é”™è¯¯";console.error("AI Studio å¤åˆ¶å¤±è´¥:",t),this.showError(`æ“ä½œå¤±è´¥ï¼š${e}`)}}generateSmartFilename(t){const e=new Date,o=e.getFullYear()+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0")+String(e.getMinutes()).padStart(2,"0")+String(e.getSeconds()).padStart(2,"0"),s=String(this.dailyCounter).padStart(3,"0"),l=this.extractFirstSentence(t),r=this.cleanSentence(l);return`${o}-${n}-${s}-${this.truncateFilename(r,50)}.md`}extractFirstSentence(t){let e=t.trim();e=e.replace(/^#+\s+/gm,""),e=e.replace(/\*\*(.+?)\*\*/g,"$1"),e=e.replace(/\*(.+?)\*/g,"$1"),e=e.replace(/`(.+?)`/g,"$1"),e=e.replace(/\[(.+?)\]\(.+?\)/g,"$1");const o=e.split(/[ã€‚.!?ï¼ï¼Ÿ\n]/);for(const t of o){const e=t.trim();if(e.length>5)return e}return e.substring(0,50).trim()}cleanSentence(t){const e=[/^å¥½çš„[ï¼!ï¼Œ,ã€‚.\s]*/i,/^å½“ç„¶[ï¼!ï¼Œ,ã€‚.\s]*/i,/^æˆ‘ä¼š[^\s]{0,5}/i,/^æˆ‘å°†[^\s]{0,5}/i,/^è®©æˆ‘[^\s]{0,5}/i,/^æ˜ç™½[äº†å—]?[ï¼!ï¼Œ,ã€‚.\s]*/i,/^æ”¶åˆ°[ï¼!ï¼Œ,ã€‚.\s]*/i,/^å¥½[çš„å•¦][ï¼!ï¼Œ,ã€‚.\s]*/i,/^OK[ï¼!ï¼Œ,ã€‚.\s]*/i,/^äº†è§£[ï¼!ï¼Œ,ã€‚.\s]*/i,/^æ²¡é—®é¢˜[ï¼!ï¼Œ,ã€‚.\s]*/i];let o=t;for(const t of e)o=o.replace(t,"");return o=o.replace(/[<>:"/\\|?*\x00-\x1F]/g,""),o=o.replace(/\s+/g,"-"),o=o.replace(/^-+|-+$/g,""),o}truncateFilename(t,e){if(t.length<=e)return t;let o=t.substring(0,e);const n=o.lastIndexOf("-");return n>.7*e&&(o=o.substring(0,n)),o}showFilenamePreview(t){const e=document.getElementById("filename-preview");e&&(e.textContent=`ğŸ“„ ${t}`,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}setupMessageListener(){chrome.runtime.onMessage.addListener(t=>{"connectionStatus"===t.type&&this.updateConnectionStatus("connected"===t.status)})}updateConnectionStatus(t){if(!this.statusElement)return;const e=this.statusElement.querySelector(".status-text"),o=this.statusElement.querySelector(".status-dot");t?(this.statusElement.classList.add("connected"),e&&(e.textContent="å·²è¿æ¥"),o&&o.classList.add("active")):(this.statusElement.classList.remove("connected"),e&&(e.textContent="æœªè¿æ¥"),o&&o.classList.remove("active"))}showSuccess(t){this.showNotification(t,"success")}showError(t){this.showNotification(t,"error")}showNotification(t,e){const o=document.createElement("div");o.className=`notification ${e}`,o.textContent=t,document.body.appendChild(o),setTimeout(()=>o.remove(),3e3)}delay(t){return new Promise(e=>setTimeout(e,t))}async loadPromptButtons(){try{let t=(await chrome.storage.local.get(["promptFiles"])).promptFiles||[];0===t.length&&(t=(await chrome.storage.sync.get(["promptFiles"])).promptFiles||[],t.length>0&&console.log("ä» sync åŠ è½½æç¤ºè¯ï¼ˆæ—§æ ¼å¼ï¼‰")),this.createPromptButtons(t)}catch(t){console.error("åŠ è½½æç¤ºè¯å¤±è´¥:",t)}}createPromptButtons(t){this.promptButtons&&0!==t.length&&(this.promptButtons.innerHTML=t.filter(t=>t.enabled).map(t=>`\n        <button \n          class="prompt-btn" \n          data-prompt-id="${t.id}"\n          data-prompt-name="${this.escapeHtml(t.name)}"\n          style="\n            padding: 8px 12px;\n            background: #6c5ce7;\n            color: white;\n            border: none;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            transition: all 0.2s;\n            text-align: left;\n          "\n          onmouseover="this.style.background='#5f4dd1'"\n          onmouseout="this.style.background='#6c5ce7'"\n        >\n          ğŸ“ ${this.escapeHtml(t.name)}\n        </button>\n      `).join(""),this.promptButtons.querySelectorAll(".prompt-btn").forEach((e,o)=>{e.__promptContent=t.filter(t=>t.enabled)[o].path,e.addEventListener("click",t=>{const e=t.currentTarget,o=e.__promptContent,n=e.getAttribute("data-prompt-name");o&&this.applyPrompt(o,n||"")})}))}async applyPrompt(t,e){try{if(console.log("ğŸ“ å¼€å§‹åº”ç”¨æç¤ºè¯:",e),!t||0===t.trim().length)return void this.showError("æç¤ºè¯å†…å®¹ä¸ºç©º");console.log("âœ… å†…å®¹é•¿åº¦:",t.length);const o=document.querySelector('button[data-test-system-instructions-card], button[aria-label="System instructions"], button.system-instructions-card');if(!o)return void this.showError("æœªæ‰¾åˆ° System Instructions æŒ‰é’®");console.log("âœ… æ‰¾åˆ° System Instructions æŒ‰é’®"),o.click(),await this.delay(500);const n=document.querySelector('textarea[aria-label="System instructions"], textarea[placeholder*="tone and style"], textarea.in-run-settings');if(!n)return this.showError("æœªæ‰¾åˆ°æ–‡æœ¬æ¡†"),void this.closeSystemInstructionsDialog();console.log("âœ… æ‰¾åˆ°æ–‡æœ¬æ¡†"),n.value="",n.value=t,n.blur(),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),n.dispatchEvent(new Event("blur",{bubbles:!0}));const s=new CustomEvent("input",{bubbles:!0,cancelable:!0});n.dispatchEvent(s),console.log("âœ… å†…å®¹å·²å¡«å……"),await this.delay(800),this.closeSystemInstructionsDialog(),this.showSuccess(`âœ… å·²åº”ç”¨: ${e}`)}catch(t){const e=t instanceof Error?t.message:"æœªçŸ¥é”™è¯¯";console.error("åº”ç”¨æç¤ºè¯å¤±è´¥:",t),this.showError(`åº”ç”¨å¤±è´¥ï¼š${e}`)}}closeSystemInstructionsDialog(){const t=["button[data-test-close-button]",'button[aria-label="Close panel"]',"button[mat-dialog-close]",'button[iconname="close"]','button.ms-button-icon[iconname="close"]','button[aria-label="Close panel"][data-test-close-button]'];let e=null;for(const o of t)if(e=document.querySelector(o),e&&null!==e.offsetParent){console.log(`âœ… æ‰¾åˆ°å…³é—­æŒ‰é’®: ${o}`);break}if(e){const t=null!==e.offsetParent,o=e.hasAttribute("aria-disabled")&&"true"===e.getAttribute("aria-disabled"),n="false"===e.getAttribute("aria-disabled")||!e.hasAttribute("aria-disabled");if(console.log("å…³é—­æŒ‰é’®çŠ¶æ€:",{isVisible:t,isDisabled:o,isEnabled:n,ariaDisabled:e.getAttribute("aria-disabled"),className:e.className}),t&&n)try{e.click(),console.log("âœ… å·²è‡ªåŠ¨å…³é—­System Instructionsç•Œé¢")}catch(t){console.error("ç‚¹å‡»å…³é—­æŒ‰é’®å¤±è´¥:",t);const o=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(o),console.log("âœ… å·²é€šè¿‡äº‹ä»¶è§¦å‘å…³é—­System Instructionsç•Œé¢")}else console.warn("âŒ å…³é—­æŒ‰é’®ä¸å¯ç”¨æˆ–å·²ç¦ç”¨",{isVisible:t,isDisabled:o,isEnabled:n})}else{console.warn("âŒ æœªæ‰¾åˆ°å¯ç”¨çš„å…³é—­æŒ‰é’®");const t=document.querySelectorAll("button");console.log("é¡µé¢ä¸Šçš„æ‰€æœ‰æŒ‰é’®:",Array.from(t).map(t=>({tagName:t.tagName,className:t.className,ariaLabel:t.getAttribute("aria-label"),dataTest:t.getAttribute("data-test-close-button"),iconName:t.getAttribute("iconname"),matDialogClose:t.getAttribute("mat-dialog-close")})))}}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}})();
//# sourceMappingURL=content.js.map