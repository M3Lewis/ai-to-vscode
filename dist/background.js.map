{"version":3,"file":"background.js","mappings":"mBAAA,IAAIA,EAAuB,KACvBC,GAAc,EACdC,EAAgC,KAChCC,EAAsB,GAE1BC,eAAeC,IACb,MAEMC,EAAQ,yBAFSC,OAAOC,QAAQC,KAAKC,IAAI,CAAEC,KAAM,QACjCA,MAAQ,OAG9BC,QAAQC,IAAI,mBAAoBP,GAEhC,IACEN,EAAK,IAAIc,UAAUR,GAEnBN,EAAGe,OAAS,KACVH,QAAQC,IAAI,gBACZZ,GAAc,EACde,GAA0B,GAiChC,WAGE,IAFAJ,QAAQC,IAAI,UAAUV,EAAac,cAE5Bd,EAAac,OAAS,GAAKhB,GAAeD,GAAI,CACnD,MAAM,QAAEkB,EAAO,aAAEC,GAAiBhB,EAAaiB,QAC/CC,EAAoBH,EAASC,EAC/B,CACF,CAvCMG,GAEIpB,IACFqB,aAAarB,GACbA,EAAiB,OAIrBF,EAAGwB,QAAU,KACXZ,QAAQC,IAAI,mBACZZ,GAAc,EACdD,EAAK,KACLgB,GAA0B,GAC1BS,KAGFzB,EAAG0B,QAAWC,IACZf,QAAQe,MAAM,gBAAiBA,GAC/B1B,GAAc,GAGhBD,EAAG4B,UAAaC,IACdjB,QAAQC,IAAI,oBAAqBgB,EAAMC,MAG3C,CAAE,MAAOH,GACPf,QAAQe,MAAM,kBAAmBA,GACjC1B,GAAc,EACdwB,GACF,CACF,CAqBA,SAAST,EAA0Be,GACjCxB,OAAOyB,KAAKC,MAAM,CAAC,EAAID,IACrBA,EAAKE,QAASC,IACRA,EAAIC,IACN7B,OAAOyB,KAAKK,YAAYF,EAAIC,GAAI,CAC9BE,KAAM,mBACNC,OAAQR,EAAY,YAAc,iBACjCS,MAAM,WAIjB,CAEA,SAASf,IACHvB,IAEJA,EAAiBuC,WAAW,KAC1B7B,QAAQC,IAAI,aACZR,KACC,KACL,CAEA,SAASgB,EAAoBH,EAAcC,GACzC,IAAKlB,IAAgBD,GAAMA,EAAG0C,aAAe5B,UAAU6B,KAOrD,OANA/B,QAAQC,IAAI,wBAlChB,SAAsBK,EAAcC,GAClCP,QAAQC,IAAI,wBACZV,EAAayC,KAAK,CAAE1B,UAASC,iBAEzBhB,EAAac,OAAS,IACRd,EAAaiB,QACrBD,aAAa,CAAE0B,SAAS,EAAOlB,MAAO,gBAElD,CA2BImB,CAAa5B,EAASC,QAEjBjB,GACHG,KAKJ,IACE,MAAM0C,EAAY,CAChBT,KAAM,WACNU,QAAS9B,EAAQ8B,QACjBC,SAAU/B,EAAQ+B,SAClBC,UAAWC,KAAKC,OAGlBpD,EAAGqD,KAAKC,KAAKC,UAAUR,IACvBnC,QAAQC,IAAI,oBAAqBK,EAAQ+B,UAEzC9B,EAAa,CAAE0B,SAAS,GAC1B,CAAE,MAAOlB,GACPf,QAAQe,MAAM,YAAaA,GAC3BR,EAAa,CAAE0B,SAAS,EAAOlB,MAAQA,EAAgBT,SACzD,CACF,CAEAX,OAAOiD,QAAQC,UAAUC,YAAY,CAACxC,EAASyC,EAAQxC,IAC9B,iBAAnBD,EAAQ0C,QACVhD,QAAQC,IAAI,aAAcK,EAAQ+B,UAClC5B,EAAoBH,EAASC,IACtB,GAGc,wBAAnBD,EAAQ0C,QACVhD,QAAQC,IAAI,aAAcZ,GAC1BkB,EAAa,CAAEY,UAAW9B,KACnB,GAGc,SAAnBiB,EAAQ0C,QACVzC,EAAa,CAAEY,UAAW9B,KACnB,QAFT,GAMFI,IAEAE,OAAOC,QAAQqD,UAAUH,YAAaI,IAChCA,EAAQnD,OACVC,QAAQC,IAAI,mBACRb,GACFA,EAAG+D,QAELtB,WAAW,IAAMpC,IAAoB,O","sources":["webpack://ai-to-vscode-bridge/./src/background.ts"],"sourcesContent":["let ws: WebSocket | null = null;\r\nlet isConnected = false;\r\nlet reconnectTimer: number | null = null; // æ”¹ä¸º number\r\nlet messageQueue: any[] = [];\r\n\r\nasync function connectWebSocket() {\r\n  const settings = await chrome.storage.sync.get({ port: 8765 });\r\n  const port = settings.port || 8765;\r\n  const wsUrl = `ws://localhost:${port}`;\r\n\r\n  console.log('å°è¯•è¿žæŽ¥åˆ° WebSocket:', wsUrl);\r\n\r\n  try {\r\n    ws = new WebSocket(wsUrl);\r\n\r\n    ws.onopen = () => {\r\n      console.log('å·²è¿žæŽ¥åˆ° VS Code');\r\n      isConnected = true;\r\n      broadcastConnectionStatus(true);\r\n      processMessageQueue();\r\n      \r\n      if (reconnectTimer) {\r\n        clearTimeout(reconnectTimer);\r\n        reconnectTimer = null;\r\n      }\r\n    };\r\n\r\n    ws.onclose = () => {\r\n      console.log('WebSocket è¿žæŽ¥å·²å…³é—­');\r\n      isConnected = false;\r\n      ws = null;\r\n      broadcastConnectionStatus(false);\r\n      scheduleReconnect();\r\n    };\r\n\r\n    ws.onerror = (error) => {\r\n      console.error('WebSocket é”™è¯¯:', error);\r\n      isConnected = false;\r\n    };\r\n\r\n    ws.onmessage = (event) => {\r\n      console.log('æ”¶åˆ°æ¥è‡ª VS Code çš„æ¶ˆæ¯:', event.data);\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error('WebSocket è¿žæŽ¥å¤±è´¥:', error);\r\n    isConnected = false;\r\n    scheduleReconnect();\r\n  }\r\n}\r\n\r\nfunction processMessageQueue() {\r\n  console.log(`å¤„ç†é˜Ÿåˆ—ä¸­çš„ ${messageQueue.length} æ¡æ¶ˆæ¯`);\r\n  \r\n  while (messageQueue.length > 0 && isConnected && ws) {\r\n    const { message, sendResponse } = messageQueue.shift();\r\n    sendMessageToVSCode(message, sendResponse);\r\n  }\r\n}\r\n\r\nfunction queueMessage(message: any, sendResponse: Function) {\r\n  console.log('WebSocket æœªè¿žæŽ¥ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—');\r\n  messageQueue.push({ message, sendResponse });\r\n  \r\n  if (messageQueue.length > 10) {\r\n    const removed = messageQueue.shift();\r\n    removed.sendResponse({ success: false, error: 'æ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡ï¼Œè¯·ç¨åŽé‡è¯•' });\r\n  }\r\n}\r\n\r\nfunction broadcastConnectionStatus(connected: boolean) {\r\n  chrome.tabs.query({}, (tabs) => {\r\n    tabs.forEach((tab) => {\r\n      if (tab.id) {\r\n        chrome.tabs.sendMessage(tab.id, {\r\n          type: 'connectionStatus',\r\n          status: connected ? 'connected' : 'disconnected'\r\n        }).catch(() => {});\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nfunction scheduleReconnect() {\r\n  if (reconnectTimer) return;\r\n  \r\n  reconnectTimer = setTimeout(() => {\r\n    console.log('å°è¯•é‡æ–°è¿žæŽ¥...');\r\n    connectWebSocket();\r\n  }, 3000) as unknown as number; // ç±»åž‹æ–­è¨€\r\n}\r\n\r\nfunction sendMessageToVSCode(message: any, sendResponse: Function) {\r\n  if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {\r\n    console.log('WebSocket æœªè¿žæŽ¥ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—');\r\n    queueMessage(message, sendResponse);\r\n    \r\n    if (!reconnectTimer) {\r\n      connectWebSocket();\r\n    }\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const wsMessage = {\r\n      type: 'saveFile',\r\n      content: message.content,\r\n      filename: message.filename,\r\n      timestamp: Date.now()\r\n    };\r\n\r\n    ws.send(JSON.stringify(wsMessage));\r\n    console.log('âœ… æ¶ˆæ¯å·²å‘é€åˆ° VS Code:', message.filename);\r\n\r\n    sendResponse({ success: true });\r\n  } catch (error) {\r\n    console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);\r\n    sendResponse({ success: false, error: (error as Error).message });\r\n  }\r\n}\r\n\r\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\r\n  if (message.action === 'sendToVSCode') {\r\n    console.log('ðŸ“¨ æ”¶åˆ°å‘é€è¯·æ±‚:', message.filename);\r\n    sendMessageToVSCode(message, sendResponse);\r\n    return true;\r\n  }\r\n  \r\n  if (message.action === 'getConnectionStatus') {\r\n    console.log('ðŸ“¡ æŸ¥è¯¢è¿žæŽ¥çŠ¶æ€:', isConnected);\r\n    sendResponse({ connected: isConnected });\r\n    return true;\r\n  }\r\n  \r\n  if (message.action === 'ping') {\r\n    sendResponse({ connected: isConnected });\r\n    return true;\r\n  }\r\n});\r\n\r\nconnectWebSocket();\r\n\r\nchrome.storage.onChanged.addListener((changes) => {\r\n  if (changes.port) {\r\n    console.log('ç«¯å£é…ç½®å·²æ›´æ”¹ï¼Œé‡æ–°è¿žæŽ¥...');\r\n    if (ws) {\r\n      ws.close();\r\n    }\r\n    setTimeout(() => connectWebSocket(), 500);\r\n  }\r\n});\r\n"],"names":["ws","isConnected","reconnectTimer","messageQueue","async","connectWebSocket","wsUrl","chrome","storage","sync","get","port","console","log","WebSocket","onopen","broadcastConnectionStatus","length","message","sendResponse","shift","sendMessageToVSCode","processMessageQueue","clearTimeout","onclose","scheduleReconnect","onerror","error","onmessage","event","data","connected","tabs","query","forEach","tab","id","sendMessage","type","status","catch","setTimeout","readyState","OPEN","push","success","queueMessage","wsMessage","content","filename","timestamp","Date","now","send","JSON","stringify","runtime","onMessage","addListener","sender","action","onChanged","changes","close"],"sourceRoot":""}