(()=>{"use strict";let e=null,o=!1,t=null,s=[];function n(n){console.log(`[${n}] 队列长度:`,s.length,", isConnected:",o,", ws:",e?e.readyState:"null",", reconnectTimer:",t)}async function c(){if(e){e.onopen=e.onclose=e.onerror=e.onmessage=null;try{e.close()}catch(e){}e=null}const c=`ws://localhost:${((await chrome.storage.sync.get("settings")).settings||{}).port||8765}`;console.log("尝试连接到 WebSocket:",c);try{e=new WebSocket(c),e.onopen=()=>{console.log("已连接到 VS Code"),o=!0,a(!0),function(){for(n("处理队列");s.length>0&&o&&e&&e.readyState===WebSocket.OPEN;){const{message:o,sendResponse:t}=s.shift();try{e.send(JSON.stringify({type:"saveFile",content:o.content,filename:o.filename,timestamp:Date.now()})),t({success:!0})}catch(e){t({success:!1,error:"object"==typeof e&&e&&"message"in e?e.message:String(e)})}}}(),t&&(clearTimeout(t),t=null),n("ws.onopen")},e.onclose=()=>{if(console.log("WebSocket 连接已关闭"),o=!1,e)try{e.close()}catch{}e=null,a(!1),i(),r("连接已断开"),n("ws.onclose")},e.onerror=e=>{console.error("WebSocket 错误:",e),o=!1},e.onmessage=e=>{console.log("收到来自 VS Code 的消息:",e.data);try{const o=JSON.parse(e.data.toString());"projectInfo"===o.type&&(console.log("活跃项目已更新:",o.rootPath),chrome.storage.local.set({activeProject:{rootPath:o.rootPath,projectName:o.projectName,timestamp:Date.now()}}))}catch(e){console.error("解析消息失败:",e)}}}catch(e){console.error("WebSocket 连接失败:",e),o=!1,i()}}function r(e="未知错误"){s.length>0&&(s.forEach(o=>{try{o.sendResponse&&o.sendResponse({success:!1,error:e})}catch{}}),s=[],console.warn(`[debug] 队列全部清空，因：${e}`))}function a(e){chrome.tabs.query({},o=>{o.forEach(o=>{o.id&&chrome.tabs.sendMessage(o.id,{type:"connectionStatus",status:e?"connected":"disconnected"}).catch(()=>{})})})}function i(){t||(t=setTimeout(()=>{console.log("尝试重新连接..."),c()},3e3))}function l(t,c){if(!o||!e||e.readyState!==WebSocket.OPEN)return function(e,o){if(s=s.filter(e=>Date.now()-e.ts<15e3),console.log("WebSocket 未连接，消息加入队列","当前队列长度:",s.length),s.length>=50){const e=s.shift();e?.sendResponse&&e.sendResponse({success:!1,error:"消息队列已满，已丢弃一条旧请求"})}s.push({message:e,sendResponse:o,ts:Date.now()})}(t,c),void n("sendMessageToVSCode: queue");try{e.send(JSON.stringify({type:"patch"===t.type?"patchFile":"saveFile",content:t.content,filename:t.filename,savePath:t.savePath||"",timestamp:Date.now()})),n("sendMessageToVSCode: sent"),c({success:!0})}catch(e){c({success:!1,error:"object"==typeof e&&e&&"message"in e?e.message:String(e)})}}chrome.runtime.onMessage.addListener((e,t,s)=>"sendToVSCode"===e.action?(n("收到发送请求"),l(e,s),!0):"captureScreenshot"===e.action?(async function(e){try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!o||!o.id)return void e({success:!1,error:"未找到活动标签页"});const t=await chrome.tabs.captureVisibleTab(o.windowId,{format:"png"});l({action:"sendToVSCode",type:"screenshot",dataUrl:t,filename:`screenshot_${Date.now()}.png`},o=>{e({...o,dataUrl:t})})}catch(o){console.error("截图失败:",o),e({success:!1,error:"截图失败: "+String(o)})}}(s),!0):"getConnectionStatus"===e.action||"ping"===e.action?(s({connected:o}),!0):void 0),c(),chrome.storage.onChanged.addListener(o=>{if(o.settings){const t=o.settings.oldValue||{},s=o.settings.newValue||{};if(t.port!==s.port){if(console.log("端口配置已更改，重新连接..."),r("端口变更清理"),e)try{e.close()}catch{}setTimeout(()=>c(),500)}}}),setInterval(()=>{if(s.length>0){const e=Date.now();let o=0;s=s.filter(t=>!(e-t.ts>15e3&&(t.sendResponse&&t.sendResponse({success:!1,error:"处理超时，后台自动清理"}),o++,1))),o>0&&console.warn(`[debug] 定时自动清理超时队列 callback: 清理了${o}条`)}},1e4)})();
//# sourceMappingURL=background.js.map