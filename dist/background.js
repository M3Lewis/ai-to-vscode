(()=>{"use strict";let e=null,o=!1,n=null,s=[];function t(t){console.log(`[${t}] 队列长度:`,s.length,", isConnected:",o,", ws:",e?e.readyState:"null",", reconnectTimer:",n)}async function c(){if(e){e.onopen=e.onclose=e.onerror=e.onmessage=null;try{e.close()}catch(e){}e=null}const c=`ws://localhost:${(await chrome.storage.sync.get({port:8765})).port||8765}`;console.log("尝试连接到 WebSocket:",c);try{e=new WebSocket(c),e.onopen=()=>{console.log("已连接到 VS Code"),o=!0,a(!0),function(){for(t("处理队列");s.length>0&&o&&e&&e.readyState===WebSocket.OPEN;){const{message:o,sendResponse:n}=s.shift();try{e.send(JSON.stringify({type:"saveFile",content:o.content,filename:o.filename,timestamp:Date.now()})),n({success:!0})}catch(e){n({success:!1,error:"object"==typeof e&&e&&"message"in e?e.message:String(e)})}}}(),n&&(clearTimeout(n),n=null),t("ws.onopen")},e.onclose=()=>{if(console.log("WebSocket 连接已关闭"),o=!1,e)try{e.close()}catch{}e=null,a(!1),l(),r("连接已断开"),t("ws.onclose")},e.onerror=e=>{console.error("WebSocket 错误:",e),o=!1},e.onmessage=e=>{console.log("收到来自 VS Code 的消息:",e.data)}}catch(e){console.error("WebSocket 连接失败:",e),o=!1,l()}}function r(e="未知错误"){s.length>0&&(s.forEach(o=>{try{o.sendResponse&&o.sendResponse({success:!1,error:e})}catch{}}),s=[],console.warn(`[debug] 队列全部清空，因：${e}`))}function a(e){chrome.tabs.query({},o=>{o.forEach(o=>{o.id&&chrome.tabs.sendMessage(o.id,{type:"connectionStatus",status:e?"connected":"disconnected"}).catch(()=>{})})})}function l(){n||(n=setTimeout(()=>{console.log("尝试重新连接..."),c()},3e3))}chrome.runtime.onMessage.addListener((n,c,r)=>"sendToVSCode"===n.action?(t("收到发送请求"),function(n,c){if(!o||!e||e.readyState!==WebSocket.OPEN)return function(e,o){if(s=s.filter(e=>Date.now()-e.ts<15e3),console.log("WebSocket 未连接，消息加入队列","当前队列长度:",s.length),s.length>=50){const e=s.shift();e?.sendResponse&&e.sendResponse({success:!1,error:"消息队列已满，已丢弃一条旧请求"})}s.push({message:e,sendResponse:o,ts:Date.now()})}(n,c),void t("sendMessageToVSCode: queue");try{e.send(JSON.stringify({type:"saveFile",content:n.content,filename:n.filename,timestamp:Date.now()})),t("sendMessageToVSCode: sent"),c({success:!0})}catch(e){c({success:!1,error:e.message})}}(n,r),!0):"getConnectionStatus"===n.action||"ping"===n.action?(r({connected:o}),!0):void 0),c(),chrome.storage.onChanged.addListener(o=>{if(o.port){if(console.log("端口配置已更改，重新连接..."),r("端口变更清理"),e)try{e.close()}catch{}setTimeout(()=>c(),500)}}),setInterval(()=>{if(s.length>0){const e=Date.now();let o=0;s=s.filter(n=>!(e-n.ts>15e3&&(n.sendResponse&&n.sendResponse({success:!1,error:"处理超时，后台自动清理"}),o++,1))),o>0&&console.warn(`[debug] 定时自动清理超时队列 callback: 清理了${o}条`)}},1e4)})();
//# sourceMappingURL=background.js.map