(()=>{"use strict";let e=null,o=!1,n=null,s=[];async function t(){const t=`ws://localhost:${(await chrome.storage.sync.get({port:8765})).port||8765}`;console.log("å°è¯•è¿žæŽ¥åˆ° WebSocket:",t);try{e=new WebSocket(t),e.onopen=()=>{console.log("å·²è¿žæŽ¥åˆ° VS Code"),o=!0,c(!0),function(){for(console.log(`å¤„ç†é˜Ÿåˆ—ä¸­çš„ ${s.length} æ¡æ¶ˆæ¯`);s.length>0&&o&&e;){const{message:e,sendResponse:o}=s.shift();r(e,o)}}(),n&&(clearTimeout(n),n=null)},e.onclose=()=>{console.log("WebSocket è¿žæŽ¥å·²å…³é—­"),o=!1,e=null,c(!1),l()},e.onerror=e=>{console.error("WebSocket é”™è¯¯:",e),o=!1},e.onmessage=e=>{console.log("æ”¶åˆ°æ¥è‡ª VS Code çš„æ¶ˆæ¯:",e.data)}}catch(e){console.error("WebSocket è¿žæŽ¥å¤±è´¥:",e),o=!1,l()}}function c(e){chrome.tabs.query({},o=>{o.forEach(o=>{o.id&&chrome.tabs.sendMessage(o.id,{type:"connectionStatus",status:e?"connected":"disconnected"}).catch(()=>{})})})}function l(){n||(n=setTimeout(()=>{console.log("å°è¯•é‡æ–°è¿žæŽ¥..."),t()},3e3))}function r(c,l){if(!o||!e||e.readyState!==WebSocket.OPEN)return console.log("WebSocket æœªè¿žæŽ¥ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—"),function(e,o){console.log("WebSocket æœªè¿žæŽ¥ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—"),s.push({message:e,sendResponse:o}),s.length>10&&s.shift().sendResponse({success:!1,error:"æ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡ï¼Œè¯·ç¨åŽé‡è¯•"})}(c,l),void(n||t());try{const o={type:"saveFile",content:c.content,filename:c.filename,timestamp:Date.now()};e.send(JSON.stringify(o)),console.log("âœ… æ¶ˆæ¯å·²å‘é€åˆ° VS Code:",c.filename),l({success:!0})}catch(e){console.error("âŒ å‘é€æ¶ˆæ¯å¤±è´¥:",e),l({success:!1,error:e.message})}}chrome.runtime.onMessage.addListener((e,n,s)=>"sendToVSCode"===e.action?(console.log("ðŸ“¨ æ”¶åˆ°å‘é€è¯·æ±‚:",e.filename),r(e,s),!0):"getConnectionStatus"===e.action?(console.log("ðŸ“¡ æŸ¥è¯¢è¿žæŽ¥çŠ¶æ€:",o),s({connected:o}),!0):"ping"===e.action?(s({connected:o}),!0):void 0),t(),chrome.storage.onChanged.addListener(o=>{o.port&&(console.log("ç«¯å£é…ç½®å·²æ›´æ”¹ï¼Œé‡æ–°è¿žæŽ¥..."),e&&e.close(),setTimeout(()=>t(),500))})})();
//# sourceMappingURL=background.js.map